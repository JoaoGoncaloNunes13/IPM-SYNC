<div class="project-page">
    <!-- Sidebar do Projeto -->
    <aside class="project-sidebar">
        <h2>{{project.name}}</h2>

        <h3 class="sidebar-title">Canais de Texto</h3>
        <ul class="channel-list">
            {{#each project.channels.texto}}
                <li class="channel-item">
                    <span onclick="openChannel('texto', '{{this.id}}', '{{this.name}}')">#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <h3 class="sidebar-title">Canais de Grupos</h3>
        <ul class="channel-list">
            {{#each project.channels.grupos}}
                <li class="channel-item">
                    <span onclick="openChannel('grupos', '{{this.id}}', '{{this.name}}')">#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <h3 class="sidebar-title">Canais de Tarefas</h3>
        <ul class="channel-list">
            {{#each project.channels.tarefas}}
                <li class="channel-item">
                    <span onclick="openChannel('tarefas', '{{this.id}}')">#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <h3 class="sidebar-title">Calendário</h3>
        <ul class="channel-list">
            {{#each project.channels.calendario}}
                <li class="channel-item">
                    <span onclick="openChannel('calendario', '{{this.id}}')">#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <button class="new-channel-btn" onclick="createChannel()">+ Novo Canal</button>

        <hr>
        <!-- Membros -->
        <h3 class="sidebar-title">Membros</h3>
        <ul id="member-list" class="member-list">
            {{#each project.members}}
                <li class="member-item">
                    <span>{{this.name}}</span>
                    <button class="remove-member" onclick="removeMember('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>
        <button class="new-member-btn" onclick="addMember()">+ Adicionar Membro</button>

    </aside>


    <main class="project-main">
        <div class="chat-header">
            <h3 id="current-channel">Bem vindo</h3>
        </div>
    </main>

</div>

<div id="create-channel-modal" class="modal hidden">
    <div class="modal-content">
        <h2>Criar novo canal</h2>

        <label>Tipo de canal:</label>
        <select id="channel-type">
            <option value="texto">Texto</option>
            <option value="tarefas">Tarefas</option>
            <option value="grupos">Grupos</option>
            <option value="calendario">Calendário</option>
        </select>

        <label>Nome do canal:</label>
        <input id="channel-name" type="text" placeholder="Nome do canal">

        <div class="modal-buttons">
            <button onclick="closeChannelModal()">Cancelar</button>
            <button onclick="submitNewChannel()">Criar</button>
        </div>
    </div>
</div>

<script>
    window.SERVER_ID = "{{project.id}}";

    async function addMember() {
        alert("Ainda não é possível adicionar membros.");

    }

    function removeMember(name) {
        alert("Ainda não é possível remover membros.");

    }

    /* --- Garante que existe o header e o h3#current-channel --- */
    function ensureChatHeader() {
        let main = document.querySelector(".project-main");
        if (!main) return null;

        let header = main.querySelector(".chat-header");
        if (!header) {
            header = document.createElement("div");
            header.className = "chat-header";
            header.innerHTML = `<h3 id="current-channel">Bem vindo</h3>`;
            main.insertBefore(header, main.firstChild);
        } else {
            let h = header.querySelector("#current-channel");
            if (!h) {
                h = document.createElement("h3");
                h.id = "current-channel";
                h.textContent = "Bem vindo";
                header.appendChild(h);
            }
        }
        return main.querySelector("#current-channel");
    }



    function createChannel() {
        const modal = document.getElementById("create-channel-modal");
        if (modal) {
            modal.classList.remove("hidden");
            modal.style.display = "block";
        }
    }

    function closeChannelModal() {
        const modal = document.getElementById("create-channel-modal");
        modal.classList.add("hidden");
        modal.style.display = "none";
    }

    async function submitNewChannel() {
        const type = document.getElementById("channel-type").value;
        const name = document.getElementById("channel-name").value.trim();

        if (!name) {
            alert("O nome do canal é obrigatório");
            return;
        }

        // POST para o backend
        const res = await fetch(`/servers/${window.SERVER_ID}/channels`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type, name })
        });

        if (!res.ok) {
            alert("Erro ao criar canal.");
            return;
        }

        const channel = await res.json();

        // Adicionar canal à sidebar
        addChannelToSidebar(type, channel);

        // Abrir canal automaticamente
        openChannel(type, channel.id);

        closeChannelModal();
    }

    /* --- openChannel (segura) --- */
    async function openChannel(type, channelId, channelName) {
        try {
            console.log("Canal atual:", type, channelId, channelName);

            // garante header seguro
            const currentEl = ensureChatHeader();
            if (currentEl) currentEl.innerText = "#" + (channelName || channelId);

            console.log("Abrindo canal:", type, channelId);

            const res = await fetch(`/servers/${window.SERVER_ID}/${type}/${channelId}`);
            if (!res.ok) {
                console.error("Erro ao carregar canal:", await res.text());
                renderError("Erro ao carregar canal.");
                return;
            }

            const channelData = await res.json();
            renderChannel(type, channelData);
        } catch (err) {
            console.error(err);
            renderError("Erro ao abrir o canal.");
        }
    }


    /* --- renderChannel: não apaga o header; escreve só em #channel-content --- */
    function renderChannel(type, data) {
        // garante header
        ensureChatHeader();

        const main = document.querySelector(".project-main");
        if (!main) return;

        // cria (ou reutiliza) o content container onde vamos injectar o conteúdo do canal
        let content = main.querySelector("#channel-content");
        if (!content) {
            content = document.createElement("div");
            content.id = "channel-content";
            // coloca logo abaixo do header
            const header = main.querySelector(".chat-header");
            if (header && header.nextSibling) main.insertBefore(content, header.nextSibling);
            else main.appendChild(content);
        }

        // limpa só o content (não o header)
        content.innerHTML = "";

        if (type === "texto") {
            renderTextChannel(content, data);
        } else if (type === "tarefas") {
            renderTaskChannel(content, data);
        } else if (type === "grupos") {
            renderGroupChannel(content, data);
        } else if (type === "calendario") {
            renderCalendarChannel(content, data);
        } else {
            content.innerHTML = `<p>Tipo de canal desconhecido</p>`;
        }
    }

    /* --- pequeno helper de erro --- */
    function renderError(msg) {
        const main = document.querySelector(".project-main");
        if (!main) return;
        let content = main.querySelector("#channel-content");
        if (!content) {
            content = document.createElement("div");
            content.id = "channel-content";
            main.appendChild(content);
        }
        content.innerHTML = `<div class="error-block">${escapeHtml(msg)}</div>`;
    }
    function renderTextChannel(container, data) {
        const html = `
        <div class="chat-messages">
            ${data.messages.map(msg => `
                <div class="message">
                    <span class="author">${msg.author}:</span>
                    <span class="content">${msg.content}</span>
                </div>
            `).join('')}
        </div>

        <div class="chat-input-container">
            <input id="chat-input" class="chat-input" placeholder="Escreve uma mensagem..." onkeypress="sendMessage(event)">
        </div>
        `;
        container.innerHTML = html;
    }

    function renderTaskChannel(container, data) {
        if (!data.tasks || data.tasks.length === 0) {
            container.innerHTML = `
                <div class="empty-block">
                    <button onclick="openCreateTaskModal()">+ Criar Tarefa</button>
                </div>
            `;
            return;
        }

        container.innerHTML = data.tasks.map(t => `
            <div class="task-card">
                <h3>${t.title}</h3>
                <p>${t.description}</p>
                <small>Prazo: ${t.deadline}</small>
                <small>Responsável: ${t.assignedTo}</small>
            </div>
        `).join('');
    }

    function openCreateTaskModal() {
        alert("Abrir modal de criar tarefa — depois implementamos o modal real");
    }

    function renderGroupChannel(container, data) {
        const groups = data.groups || []; // garante que sempre é um array
        if (groups.length === 0) {
            container.innerHTML = `
            <div class="empty-block">
                <button onclick="openCreateGroupModal()">+ Criar Grupo</button>
            </div>
        `;
            return;
        }
        container.innerHTML = groups.map(g => `
        <div class="group-card">
            <h3>${g.name}</h3>
        </div>
    `).join('');
    }


    function openCreateGroupModal() {
        alert("Abrir modal para criar grupo — depois implementamos");
    }

    function renderCalendarChannel(container, data) {
        container.innerHTML = `
            <h2>Calendário do Projeto</h2>
            <p>(Aqui vais colocar o calendário futuro)</p>
        `;
    }

    function sendMessage(e) {
        if (e.key !== "Enter") return;

        const input = document.getElementById("chat-input");
        const text = input.value.trim();
        if (!text) return;

        const msgObj = { author: "Tu", text };
        channelMessages[currentChannel].push(msgObj);
        loadMessages();
        input.value = "";
    }
    function addChannelToSidebar(type, channel) {
        const list = document.querySelector(`ul.channel-list:nth-of-type(${getListIndex(type)})`);
        if (!list) return;

        const li = document.createElement("li");
        li.className = "channel-item";
        li.innerHTML = `
            <span onclick="openChannel('${type}', '${channel.id}', '${channel.name}')">#${channel.name}</span>
            <button class="delete-channel" onclick="deleteChannel('${channel.id}')">×</button>
        `;

        list.appendChild(li);
    }

    function getListIndex(type) {
        if (type === "texto") return 1;
        if (type === "grupos") return 2;
        if (type === "tarefas") return 3;
        if (type === "calendario") return 4;
    }
</script>

