<div class="project-page">
    <!-- Sidebar do Projeto -->
    <aside class="project-sidebar">
        <h2>{{project.name}}</h2>

        <h3 class="sidebar-title">Canais de Texto</h3>
        <ul class="channel-list">
            {{#each project.channels.texto}}
                <li class="channel-item">
                    <span>#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <h3 class="sidebar-title">Canais de Grupos</h3>
        <ul class="channel-list">
            {{#each project.channels.grupos}}
                <li class="channel-item">
                    <span>#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <h3 class="sidebar-title">Canais de Tarefas</h3>
        <ul class="channel-list">
            {{#each project.channels.tarefas}}
                <li class="channel-item">
                    <span>#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <h3 class="sidebar-title">Calendário</h3>
        <ul class="channel-list">
            {{#each project.channels.calendario}}
                <li class="channel-item">
                    <span>#{{this.name}}</span>
                    <button class="delete-channel" onclick="deleteChannel('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>

        <button class="new-channel-btn" onclick="createChannel()">+ Novo Canal</button>

        <hr>
        <!-- Membros -->
        <h3 class="sidebar-title">Membros</h3>
        <ul id="member-list" class="member-list">
            {{#each project.members}}
                <li class="member-item">
                    <span>{{this.name}}</span>
                    <button class="remove-member" onclick="removeMember('{{this.id}}')">×</button>
                </li>
            {{/each}}
        </ul>
        <button class="new-member-btn" onclick="addMember()">+ Adicionar Membro</button>

    </aside>


    <main class="project-main">
        <div class="chat-header">
            <h3 id="current-channel">#geral</h3>
        </div>

        <div id="chat-messages" class="chat-messages">
            <div class="message">
                <span class="author">Sistema:</span>
                <span class="content">Bem-vindo ao canal #geral!</span>
            </div>
        </div>

        <div class="chat-input-container">
            <input
                    id="chat-input"
                    class="chat-input"
                    placeholder="Escreve uma mensagem..."
                    onkeypress="sendMessage(event)"
            />
        </div>
    </main>

</div>
<script>
    window.SERVER_ID = {{project.id}};

    async function addMember() {
        const name = prompt("Nome do novo membro:");
        if (!name) return;

        const serverId = window.SERVER_ID;

        try {
            const response = await fetch(`/servers/${serverId}/validate-member`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: name })
            });

            if (!response.ok) {
                const msg = await response.text();
                alert("Utilizador inválido: " + msg);
                return;
            }

            const data = await response.json();
            if (data.valid) {
                const ul = document.getElementById("member-list");
                const li = document.createElement("li");
                li.className = "member-item";
                li.innerHTML = `
                    <span>${name}</span>
                    <button class="remove-member" onclick="removeMember('${name}')">×</button>
                `;
                ul.appendChild(li);
            }

        } catch (err) {
            console.error(err);
            alert("Erro ao validar utilizador.");
        }
    }

    function removeMember(name) {
        if (!confirm(`Remover membro ${name}?`)) return;

        document.querySelectorAll(".member-item").forEach(member => {
            if (member.textContent.includes(name)) member.remove();
        });
    }

    // Chat e canais
    let currentChannel = "geral";
    let channelMessages = { geral: [] };

    function createChannel() {
        const name = prompt("Nome do novo canal:");
        if (!name) return;

        if (!channelMessages[name]) channelMessages[name] = [];

        const ul = document.querySelector(".channel-list");
        const li = document.createElement("li");
        li.className = "channel-item";
        li.innerHTML = `
            <span onclick="openChannel('${name}')">#${name}</span>
            <button class="delete-channel" onclick="deleteChannel('${name}')">×</button>
        `;
        ul.appendChild(li);
    }

    function deleteChannel(name) {
        if (!confirm(`Apagar canal #${name}?`)) return;

        delete channelMessages[name];

        document.querySelectorAll(".channel-item").forEach(ch => {
            if (ch.textContent.includes("#" + name)) ch.remove();
        });

        if (currentChannel === name) {
            currentChannel = null;
            document.getElementById("chat-messages").innerHTML = "";
            document.getElementById("current-channel").textContent = "Canal apagado";
        }
    }

    function openChannel(name) {
        currentChannel = name;
        document.getElementById("current-channel").textContent = "#" + name;
        loadMessages();
    }

    function loadMessages() {
        const messagesDiv = document.getElementById("chat-messages");
        messagesDiv.innerHTML = "";

        const msgs = channelMessages[currentChannel] || [];
        msgs.forEach(msg => {
            const div = document.createElement("div");
            div.className = "message";
            div.innerHTML = `<span class="author">${msg.author}:</span> <span class="content">${msg.text}</span>`;
            messagesDiv.appendChild(div);
        });

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage(e) {
        if (e.key !== "Enter") return;

        const input = document.getElementById("chat-input");
        const text = input.value.trim();
        if (!text) return;

        const msgObj = { author: "Tu", text };
        channelMessages[currentChannel].push(msgObj);
        loadMessages();
        input.value = "";
    }
</script>

